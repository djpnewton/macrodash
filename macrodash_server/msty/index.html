<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MSTY/MSTR/BTC Income Comparison</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { margin: 2em; }
    .form-label { margin-top: 1em; }
    table { margin-top: 2em; }
    th, td { text-align: right; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">MSTY/MSTR/BTC Income Comparison</h1>
    <form id="compare-form" class="row g-3">
      <div class="col-md-4">
        <label for="initial" class="form-label">Initial Capital:</label>
        <input type="number" class="form-control" id="initial" value="100000" min="0" step="1000">
      </div>
      <div class="col-md-4">
        <label for="spend" class="form-label">Monthly Spend:</label>
        <input type="number" class="form-control" id="spend" value="5000" min="0" step="100">
      </div>
      <div class="col-md-4">
        <label for="ticker" class="form-label">Investment:</label>
        <select id="ticker" class="form-select">
          <option value="MSTY">MSTY</option>
          <option value="MSTR">MSTR</option>
          <option value="BTC-USD">BTC</option>
          <option value="ALL">All</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="range" class="form-label">Range:</label>
        <select id="range" class="form-select">
          <option value="sixMonths">6 Months</option>
          <option value="oneYear">1 Year</option>
        </select>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary mt-3">Compare</button>
      </div>
    </form>

    <div id="result" class="mt-4"></div>
    <canvas id="capitalChart" height="80" class="my-4"></canvas>
    <canvas id="capitalChartAll" height="80" class="my-4" style="display:none"></canvas>
  </div>

  <script>

    async function fetchData(ticker, range) {
      //const baseUrl = 'http://localhost:8080';
      const baseUrl = 'https://macrodash-server.fly.dev';
      const url = `${baseUrl}/market/custom?ticker1=${ticker}&range=${range}&interval=oneMonth`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to fetch data');
      return res.json();
    }

    function simulateInvestment(priceData, initial, spend, dividendData = []) {
      // "amount" is the price at that date
      let shares = 0;
      let history = [];
      let totalUnitsLiquidated = 0;
      for (let i = 0; i < priceData.length; i++) {
        const price = priceData[i].amount;
        let unitsLiquidated = 0;
        if (i === 0) {
          shares = initial / price;
        }
        // Find dividend for this date if available
        let dividend = 0;
        if (dividendData && dividendData.length) {
          const div = dividendData.find(d => d.date.slice(0, 10) === priceData[i].date.slice(0, 10));
          if (div) dividend = div.amount;
        }
        // Calculate total dividend for this period
        const totalDividend = shares * dividend;

        // Use total dividend for spend first
        let spendCoveredByDividend = Math.min(totalDividend, spend);
        let spendRemaining = spend - spendCoveredByDividend;

        // If total dividend exceeds spend, reinvest the excess
        let reinvestAmount = totalDividend > spend ? totalDividend - spend : 0;
        if (reinvestAmount > 0) {
          const reinvestedShares = reinvestAmount / price;
          shares += reinvestedShares;
          unitsLiquidated -= reinvestedShares; // Negative units liquidated for reinvestment
        }

        // If spend is not fully covered by dividend, liquidate shares to cover the rest
        if (spendRemaining > 0) {
          const spendShares = spendRemaining / price;
          if (shares >= spendShares) {
            shares -= spendShares;
            unitsLiquidated += spendShares;
          } else {
            // Not enough shares to cover spend, liquidate all remaining shares
            unitsLiquidated += shares;
            shares = 0;
          }
          totalUnitsLiquidated += unitsLiquidated;
        }

        const capital = shares * price;
        history.push({
          date: priceData[i].date,
          price: price,
          capital: capital,
          shares: shares,
          unitsLiquidated: unitsLiquidated,
          dividend: dividend,
          totalDividend: totalDividend,
          reinvested: reinvestAmount
        });
      }
      return history;
    }

    function renderTable(history) {
      let html = `<table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Price</th>
            <th>Dividend</th>
            <th>Total Dividend</th>
            <th>Reinvested</th>
            <th>Units Held</th>
            <th>Units Liquidated</th>
            <th>Capital</th>
          </tr>
        </thead>
        <tbody>`;
      for (const entry of history) {
        html += `<tr>
          <td>${entry.date.slice(0,10)}</td>
          <td>$${entry.price?.toLocaleString(undefined, {maximumFractionDigits:2}) ?? 'N/A'}</td>
          <td>$${entry.dividend?.toLocaleString(undefined, {maximumFractionDigits:4}) ?? '0.0000'}</td>
          <td>$${entry.totalDividend?.toLocaleString(undefined, {maximumFractionDigits:2}) ?? '0.00'}</td>
          <td>$${entry.reinvested?.toLocaleString(undefined, {maximumFractionDigits:2}) ?? '0.00'}</td>
          <td>${entry.shares.toLocaleString(undefined, {maximumFractionDigits:6})}</td>
          <td>${entry.unitsLiquidated?.toLocaleString(undefined, {maximumFractionDigits:6}) ?? '0.000000'}</td>
          <td>$${entry.capital.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      return html;
    }

    function renderChart(history) {
      const ctx = document.getElementById('capitalChart').getContext('2d');
      // Remove old chart if it exists
      if (window.capitalChartInstance) {
        window.capitalChartInstance.destroy();
      }
      const labels = history.map(entry => entry.date.slice(0, 10));
      const data = history.map(entry => entry.capital);
      window.capitalChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Capital Over Time',
            data: data,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            fill: true,
            tension: 0.2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Capital ($)' } }
          }
        }
      });
    }

    async function fetchAllData(tickers, range) {
      return Promise.all(
        tickers.map(ticker =>
          fetchData(ticker, range).then(response => ({
            ticker,
            response
          }))
        ));
    }

    function renderChartAll(histories, names) {
      const ctx = document.getElementById('capitalChartAll').getContext('2d');
      if (window.capitalChartAllInstance) {
        window.capitalChartAllInstance.destroy();
      }
      const datasets = histories.map((history, idx) => ({
        label: names[idx],
        data: history.map(entry => entry.capital),
        borderColor: ['#36a2eb', '#ff6384', '#4bc0c0'][idx],
        backgroundColor: 'rgba(0,0,0,0)',
        fill: false,
        tension: 0.2,
        pointRadius: 0
      }));
      const labels = histories[0].map(entry => entry.date.slice(0, 10));
      window.capitalChartAllInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Capital ($)' } }
          }
        }
      });
    }

    document.getElementById('compare-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const initial = parseFloat(document.getElementById('initial').value);
      const spend = parseFloat(document.getElementById('spend').value);
      const ticker = document.getElementById('ticker').value;
      const range = document.getElementById('range').value;
      const resultDiv = document.getElementById('result');
      const chart = document.getElementById('capitalChart');
      const chartAll = document.getElementById('capitalChartAll');

      // Hide charts while loading
      chart.style.display = "none";
      chartAll.style.display = "none";
      resultDiv.innerHTML = '<div class="alert alert-info">Loading...</div>';

      if (ticker === "ALL") {
        const tickers = ["MSTY", "MSTR", "BTC-USD"];
        const names = ["MSTY", "MSTR", "BTC"];
        try {
          const allData = await fetchAllData(tickers, range);
          let html = "";
          const histories = [];
          for (let i = 0; i < allData.length; i++) {
            const priceData = allData[i].response.priceData;
            const dividendData = allData[i].response.dividendData || [];
            const history = simulateInvestment(priceData, initial, spend, dividendData);
            histories.push(history);
            html += `<h2 class="mt-4">Results for ${names[i]}</h2>` +
              renderTable(history) +
              `<div class="alert alert-success"><strong>Final Capital:</strong> $${history[history.length-1].capital.toLocaleString(undefined, {maximumFractionDigits:2})}</div>`;
          }
          resultDiv.innerHTML = html;
          chart.style.display = "none";
          chartAll.style.display = "";
          renderChartAll(histories, names);
        } catch (err) {
          resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
          if (window.capitalChartAllInstance) {
            window.capitalChartAllInstance.destroy();
          }
        }
      } else {
        try {
          const response = await fetchData(ticker, range);
          const priceData = response.priceData;
          const dividendData = response.dividendData || [];
          const history = simulateInvestment(priceData, initial, spend, dividendData);
          resultDiv.innerHTML = `<h2 class="mt-4">Results for ${ticker}</h2>` +
            renderTable(history) +
            `<div class="alert alert-success"><strong>Final Capital:</strong> $${history[history.length-1].capital.toLocaleString(undefined, {maximumFractionDigits:2})}</div>`;
          chart.style.display = "";
          chartAll.style.display = "none";
          renderChart(history);
        } catch (err) {
          resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
          if (window.capitalChartInstance) {
            window.capitalChartInstance.destroy();
          }
        }
      }
    });
  </script>
</body>
</html>